---
name: setup-ci
description: |
  Sets up everything necessary to run earthly for CI
author: "@powertoolsdev/team"
inputs:
  # TODO(jdt): add to earthly and remove from here
  tfcloud_token:
    description: The token used to authenticate to Terraform Cloud
  clone_token:
    description: |
      The token generated by powertoolsdev/mono/actions/app-token.
      Used to pull dependencies.
  github_token:
    description: "GITHUB_TOKEN"
    default: "${{ github.token }}"
  buf_auth_token:
    description: Buf auth token
    default: ""
  aws_role:
    description: |
      (Optional) The AWS role to assume.
      Used for setting up AWS credentials.
    default: ""
  aws_region:
    description: |
      (Optional) The AWS region to use.
      Used for setting up AWS credentials.
    default: "us-west-2"
  ecr_registries:
    description: |
      (Optional) The ECR registries to log into.
    default: ""
  setup_helm:
    description: |
      (Optional) Whether to set up helm
    default: "true"
  helm_repos:
    description: |
      (Optional) The helm repos to add.
      See actions/setup-helm for format.
    default: ""

runs:
  using: "composite"
  steps:
    # NOTE(jdt): this will set our scripts to trace mode if workflow is ran in "debug"
    - shell: bash
      # run: echo "TRACE=${RUNNER_DEBUG}" >> "$GITHUB_ENV"
      run: echo "TRACE=1" >> "$GITHUB_ENV"

    - name: Setup earthly
      uses: earthly/actions-setup@v1.0.5
      with:
        version: latest
        github-token: ${{ inputs.github_token }}

    # TODO(jdt): add to earthly and remove from here
    - name: Setup terraform
      uses: hashicorp/setup-terraform@v2
      with:
        cli_config_credentials_token: ${{ inputs.tfcloud_token }}

    # This is so we can use RUN --ssh in GHA
    - name: Setup dummy SSH agent
      shell: bash
      run: |
        [[ -n "${TRACE:-}" ]] && set -x

        ssh-keygen -t rsa -q -f "$HOME/.ssh/id_rsa" -N ""
        eval "$(ssh-agent -s)"
        {
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK"
          echo "SSH_AGENT_PID=$SSH_AGENT_PID"
        } >> "$GITHUB_ENV"

        # need to specify earthly config to use remote targets...
        cat <<EOF > ~/.earthly/config.yml
        git:
          github.com:
            auth: https
            user: x-access-token
            password: ${{ inputs.clone_token }}
        EOF

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.github_token }}

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2.0.0
      if: ${{ inputs.aws_role != '' }}
      with:
        role-to-assume: ${{ inputs.aws_role }}
        aws-region: ${{ inputs.aws_region }}

    - name: Login to Amazon ECR
      if: ${{ inputs.ecr_registries != '' }}
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
      with:
        registries: ${{ inputs.ecr_registries }}

    - name: Setup earthly args
      shell: bash
      run: |
        [[ -n "${TRACE:-}" ]] && set -x

        # grab existing build args
        readarray -d ',' -t build_args < <(printf "%s" "$EARTHLY_BUILD_ARGS")
        # append additional args
        build_args+=("GITHUB_ACTIONS=1")
        printf -v build_args "%s," "${build_args[@]}"

        # grab existing earthly args
        readarray -d ' ' -t extra_args < <(printf "%s" "$EARTHLY_EXTRA_ARGS")
        # append additional args
        [[ ${{ github.event_name }} != "pull_request" ]] && extra_args+=(--push)
        extra_args+=("--strict")
        printf -v extra_args "%s " "${extra_args[@]}"

        # grab existing secrets
        readarray -d ',' -t secrets < <(printf "%s" "$EARTHLY_SECRETS")
        # append additional secrets
        secrets+=("github_token=${{ inputs.github_token }}")
        secrets+=("buf_token=${{ inputs.buf_auth_token }}")
        secrets+=("clone_token=${{ inputs.clone_token }}")
        secrets+=("GITHUB_TOKEN=${{ inputs.github_token }}")
        secrets+=("BUF_TOKEN=${{ inputs.buf_auth_token }}")
        secrets+=("AWS_REGION=${{ env.AWS_REGION}}")
        secrets+=("AWS_ACCESS_KEY_ID=${{ env.AWS_ACCESS_KEY_ID}}")
        secrets+=("AWS_SECRET_ACCESS_KEY=${{ env.AWS_SECRET_ACCESS_KEY}}")
        secrets+=("AWS_SESSION_TOKEN=${{ env.AWS_SESSION_TOKEN}}")
        printf -v secrets "%s," "${secrets[@]}"

        # export to env
        {
          echo "EARTHLY_BUILD_ARGS=${build_args%,}"
          echo "EARTHLY_EXTRA_ARGS=${extra_args% }"
          echo "EARTHLY_SECRETS=${secrets%,}"
        } >> "$GITHUB_ENV"

    - shell: bash
      run: |
        [[ -n "${TRACE:-}" ]] && set -x

        [[ -n "${{ inputs.aws_role }}" ]] \
                                      && [[ -d ./k8s ]] \
                                      && [[ "${{ inputs.setup_helm }}" = 'true' ]] \
                                      && echo "NEEDS_HELM=true" >> "$GITHUB_ENV"
        exit 0

    - name: Setup helm
      if: ${{ env.NEEDS_HELM == 'true' }}
      uses: powertoolsdev/mono/actions/setup-helm@main
      with:
        repos: ${{ inputs.helm_repos }}

branding:
  icon: "check"
  color: "blue"
