VERSION --use-cache-command 0.6

FROM ghcr.io/powertoolsdev/ci-go-builder

WORKDIR /src

ARG GOCACHE=/go-cache
ARG GOMODCACHE=/go-mod-cache
CACHE $GOCACHE
CACHE $GOMODCACHE
ARG GHCR_IMAGE=ghcr.io/powertoolsdev/mono-pkg:cache

# code should be used to consume pkg as code. It exports the fully generated pkg
code:
    FROM ../.+deps
    COPY --dir . ./pkg
    # TODO(jm): create a better way to share the GQL schema, that doesn't require importing a service like this. Should
    # the schema just live in some type of top level directory?
    COPY ../services/api-gateway+gql-schema/services /src/services
    DO +GEN

    SAVE ARTIFACT pkg
    SAVE IMAGE --push $GHCR_IMAGE

test:
    FROM +code
    RUN go test -cover ./...

test-integration:
    FROM +code
    RUN go test -tags=integration ./...

lint:
    RUN echo "noop..."

GEN:
    COMMAND
    # TODO(jm): this should be able to go away
    DO ./types+BUF_LOGIN
    RUN go generate ./...
