VERSION --use-cache-command 0.6

FROM ../../images/go-base+build-base

WORKDIR /src

ARG NAME=e2e
ARG GOCACHE=/go-cache
ARG GOMODCACHE=/go-mod-cache

CACHE $GOCACHE
CACHE $GOMODCACHE

code:
    FROM ../../.+deps
    COPY ../../pkg+code/pkg pkg
    COPY --dir . ./services/$NAME
    WORKDIR services/$NAME
    RUN go generate ./...

build:
    FROM +code
    RUN echo "building api..." && \
        go \
        build \
        -o ./out/api \
        ./api

    RUN echo "building worker..." && \
        go \
        build \
        -o ./out/worker \
        ./worker

    RUN ls ./out
    SAVE ARTIFACT ./out

lint:
    RUN echo "noop..."

test:
    FROM +code
    RUN go test ./...

artifacts:
    RUN echo "noop..."
    RUN mkdir -p out && \
      touch out/.ignore
    SAVE ARTIFACT out AS LOCAL ./out

terraform:
    COPY --dir nuon/* out/
    SAVE ARTIFACT out

oci-artifacts:
    FROM ../../images/go-base+alpine-base

    ARG repo=
    ARG image_tag=

    COPY +build/out/api /bin/api
    COPY +build/out/worker /bin/worker

    SAVE IMAGE --push $repo:$image_tag
