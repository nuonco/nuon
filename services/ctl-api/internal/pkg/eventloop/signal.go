package eventloop

import (
	"bytes"
	"context"
	"fmt"
	"text/template"

	"go.temporal.io/sdk/workflow"
	"gorm.io/gorm"

	"github.com/go-playground/validator/v10"

	"github.com/powertoolsdev/mono/services/ctl-api/internal/app"
	"github.com/powertoolsdev/mono/services/ctl-api/internal/pkg/cctx"
)

type SignalType string

type Signal interface {
	WorkflowID(id string) string
	WorkflowName() string
	Namespace() string
	Name() string
	SignalType() SignalType

	// for managing intra-workflow communication
	Listeners() []SignalListener

	// for managing context
	GetOrg(ctx context.Context, id string, db *gorm.DB) (*app.Org, error)
	PropagateContext(ctx cctx.ValueContext) error
	GetWorkflowContext(ctx workflow.Context) workflow.Context
	GetContext(ctx context.Context) context.Context

	// lifecycle methods
	Validate(*validator.Validate) error
	Stop() bool
	Restart() bool
	Start() bool
}

// SignalHandlerWorkflowID returns the standard ID to use for a signal handler child workflow
func SignalHandlerWorkflowID(sig Signal, req EventLoopRequest) string {
	return fmt.Sprintf("sig-%s-%s", sig.SignalType(), req.ID)
}

type IDTemplateVars struct {
	// CallerID is the workflow ID of the workflow that is calling this workflow as a child. Set to "root" if there is no parent.
	CallerID string

	// Req is the request argument passed in to the workflow. This is the same as the argument passed to the invoked workflow function.
	Req any
}

// WorkflowIDTemplate creates a workflow ID by evaluating the provided template string in the context of the given request.
//
// This is expected to be called from code generated by temporal-gen.
func WorkflowIDTemplate(ctx workflow.Context, req any, tmpl string) string {
	t, err := template.New("workflowID").Parse(tmpl)
	if err != nil {
		panic(fmt.Sprintf("failed to parse workflow ID template: %v", err))
	}

	vars := IDTemplateVars{
		CallerID: workflow.GetInfo(ctx).WorkflowExecution.ID,
		Req:      req,
	}
	buf := new(bytes.Buffer)
	if err := t.Execute(buf, vars); err != nil {
		panic(fmt.Sprintf("failed to execute workflow ID template: %v", err))
	}
	return buf.String()
}
