# Default values for buildkit chart

# Node pool configuration
nodePool:
  name: "buildkit"  # The name of the node pool to deploy on

# BuildKit agent configuration
buildkit:
  replicas: 1
  image:
    repository: moby/buildkit
    tag: latest
    pullPolicy: IfNotPresent
  resources:
    limits:
      cpu: 10000m
      memory: 24Gi
  securityContext:
    privileged: true
  persistence:
    storageClass: "gp2"
    size: "300Gi"
  port: 1234
  
  # BuildKit configuration
  config:
    root: "/var/lib/buildkit"
    worker:
      containerd:
        enabled: false
      oci:
        enabled: true
        gc: true                      # Enable garbage collection
        gckeepstorage: 300000000000    # Keep up to 30GB of storage before triggering GC
        snapshotter: "overlayfs"      # Use overlayfs snapshotter for filesystem layers
        gcpolicy:
          # Policy for source code, cache mounts, and git checkouts
          - filters: ["type==source.local", "type==exec.cachemount", "type==source.git.checkout"]
            keepBytes: 10240000000    # Keep ~10GB of these specific types of cache
            keepDuration: 604800      # Keep for 7 days (in seconds)
          
          # General policy for other cache types
          - keepBytes: 300000000000    # Keep up to 30GB of other cache types
          
          # Fallback policy
          - all: true                 # Apply to any remaining cache entries
            keepBytes: 300000000000    # Total cache shouldn't exceed 30GB

# Envoy proxy configuration
proxy:
  replicas: 1
  image:
    repository: envoyproxy/envoy-dev
    tag: latest
    pullPolicy: IfNotPresent
  resources: 
    limits:
      cpu: 1000m
      memory: 1Gi
  service:
    type: LoadBalancer

  # Envoy configuration
  config:
    admin:
      port: 9901
      

# TLS configuration
tls:
  enabled: true
  # When enabled, create these secrets or provide them externally
  secretName: buildkit-envoy-certs

# Namespace to deploy resources
namespace: buildkit
