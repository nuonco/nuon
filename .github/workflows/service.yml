---
name: service
"on":
  workflow_call:
    inputs:
      service:
        type: string
        required: true
      prod:
        type: boolean
        required: true
      stage:
        type: boolean
        required: true
      tag:
        type: string
        required: true
    outputs: {}

defaults:
  run:
    shell: bash

jobs:
  terraform:
    name: Get terraform outputs
    uses: ./.github/workflows/terraform_outputs.yml
    secrets: inherit
    with:
      dir: services/${{ inputs.service }}/infra
      cache-key: ${{ inputs.service }}
      workspace: stage

  lint:
    name: ğŸŒ lint
    uses: ./.github/workflows/service_lint.yml
    secrets: inherit
    with:
      service: ${{ inputs.service }}
    needs:
      - terraform

  test:
    name: ğŸŒ test
    uses: ./.github/workflows/service_test.yml
    secrets: inherit
    with:
      service: ${{ inputs.service }}
    needs:
      - terraform

  release:
    name: ğŸ“¦ release
    if: ${{ inputs.stage || inputs.prod }}
    needs:
      - terraform
      - lint
      - test
    uses: ./.github/workflows/service_release.yml
    secrets: inherit
    with:
      service: ${{ inputs.service }}
      tag: ${{ inputs.tag }}

  deploy-stage:
    name: â˜ï¸  deploy stage
    # only run on main, or when the auto-deploy label is set
    if: ${{ inputs.stage }}
    needs:
      - release
    uses: ./.github/workflows/service_deploy.yml
    secrets: inherit
    with:
      env: stage
      tag: ${{ needs.release.outputs.image_tag }}
      service: ${{ inputs.service }}

  deploy-prod:
    if: ${{ inputs.prod }}
    name: â˜ï¸  deploy prod
    needs:
      - release
    uses: ./.github/workflows/service_deploy.yml
    secrets: inherit
    with:
      env: prod
      tag: ${{ needs.release.outputs.image_tag }}
      service: ${{ inputs.service }}
