---
name: artifact publish
"on":
  workflow_call:
    inputs:
      artifact:
        type: string
        required: true
      tag:
        type: string
        required: true

defaults:
  run:
    shell: bash

jobs:
  publish:
    name: ðŸŒ publish
    runs-on: [ubuntu-latest-16-cores, linux]
    permissions:
      contents: read
      packages: write
      id-token: write
    env:
      TF_OUT: ${{ github.workspace }}/tf-out.json
    timeout-minutes: 9
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup terraform
        uses: hashicorp/setup-terraform@v2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_KEY }}

      - name: Get terraform outputs
        shell: bash
        working-directory: infra/artifacts
        run: |
          terraform init
          terraform-bin output -json > ${{ env.TF_OUT }}

      - name: Parse output
        uses: powertoolsdev/action-tf-output@main
        with:
          file: ${{ env.TF_OUT }}

      - name: Setup for CI
        uses: powertoolsdev/mono/actions/setup-ci@main
        with:
          aws_role: ${{ env.TFO_GH_ROLE_ARN }}
          aws_region: ${{ env.TFO_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        with:
          registries: ${{ env.TFO_ARTIFACTS_NUONCTL_ECR_REGISTRY_ID }}
          registry-type: ${{ env.NUONCTL_TFO_ARTIFACTS_NUONCTL_ECR_IS_PUBLIC && 'public' || 'private' }}

      - name: Earthly build artifacts
        working-directory: bins/${{inputs.artifact}}
        run: |
          earthly \
            --allow-privileged \
            ${{ env.EARTHLY_EXTRA_ARGS }} \
            --ci \
            --remote-cache=ghcr.io/${{ github.repository }}-pkg:cache \
            --artifact +artifacts/out && \
            ls

      - name: push artifacts to s3
        working-directory: bins/${{inputs.artifact}}
        run: aws s3 sync ./out s3://${{ env.TFO_BUCKET_NAME }}/${{ inputs.artifact }}/${{ inputs.tag }}/

      - name: Build and push oci-artifact
        working-directory: bins/${{inputs.artifact}}
        run: |
          earthly \
            ${{ env.EARTHLY_EXTRA_ARGS }} \
            --ci \
            --push \
            --remote-cache=ghcr.io/${{ github.repository }}-pkg:cache \
            +oci-artifacts \
            --repo=${{ env.TFO_ARTIFACTS_NUONCTL_ECR_REPOSITORY_URL }} \
            --image_tag=${{ inputs.tag }}
