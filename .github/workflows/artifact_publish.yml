---
name: artifact publish
"on":
  workflow_call:
    inputs:
      dir:
        type: string
        required: true
      tag:
        type: string
        required: true

defaults:
  run:
    shell: bash

jobs:
  publish:
    name: ðŸŒ publish
    runs-on: [ubuntu-latest-16-cores, linux]
    permissions:
      contents: read
      packages: write
      id-token: write
    env:
      TF_OUT: ${{ github.workspace }}/tf-out.json
    timeout-minutes: 9
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_KEY }}

      - name: Get terraform outputs
        shell: bash
        working-directory: infra/artifacts
        run: |
          terraform init
          terraform-bin output -json > ${{ env.TF_OUT }}

          which jq

      - name: Parse output
        uses: powertoolsdev/action-tf-output@main
        with:
          cleanup: false
          file: ${{ env.TF_OUT }}

      - name: Parse artifact outputs
        working-directory: infra/artifacts
        run: |
          repo_url=$(cat ${{ env.TF_OUT }} | jq -r '.artifacts.value."${{ inputs.dir }}".ecr.repository_url')
          repo_arn=$(cat ${{ env.TF_OUT }} | jq -r '.artifacts.value."${{ inputs.dir }}".ecr.repository_arn')
          is_public=$(cat ${{ env.TF_OUT }} | jq -r '.artifacts.value."${{ inputs.dir }}".ecr.is_public')
          registry_id=$(cat ${{ env.TF_OUT }} | jq -r '.artifacts.value."${{ inputs.dir }}".ecr.registry_id')
          bucket_prefix=$(cat ${{ env.TF_OUT }} | jq -r '.artifacts.value."${{ inputs.dir }}".bucket_prefix')
          region=$(cat ${{ env.TF_OUT }} | jq -r '.artifacts.value."${{ inputs.dir }}".ecr.region')

          echo "ARTIFACT_ECR_REPOSITORY_URL=$repo_url" >> "$GITHUB_ENV"
          echo "ARTIFACT_ECR_REPOSITORY_ARN=$repo_arn" >> "$GITHUB_ENV"
          echo "ARTIFACT_ECR_IS_PUBLIC=$is_public" >> "$GITHUB_ENV"
          echo "ARTIFACT_ECR_REGISTRY_ID=$registry_id" >> "$GITHUB_ENV"
          echo "ARTIFACT_BUCKET_PREFIX=$bucket_prefix" >> "$GITHUB_ENV"
          echo "ARTIFACT_REGION=$region" >> "$GITHUB_ENV"

      - name: Setup for CI
        uses: powertoolsdev/mono/actions/setup-ci@main
        with:
          aws_role: ${{ env.TFO_GH_ROLE_ARN }}
          aws_region: ${{ env.ARTIFACT_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        with:
          registries: ${{ env.ARTIFACT_ECR_REGISTRY_ID }}
          registry-type: ${{ env.ARTIFACT_ECR_IS_PUBLIC == 'true' && 'public' || 'private' }}

      - name: Earthly build artifacts
        working-directory: ${{ inputs.dir }}
        run: |
          earthly \
            --allow-privileged \
            ${{ env.EARTHLY_EXTRA_ARGS }} \
            --ci \
            --remote-cache=ghcr.io/${{ github.repository }}-pkg:cache \
            --artifact +artifacts/out \
            --version=${{ inputs.tag }}

      - name: push artifacts to s3
        working-directory: ${{ inputs.dir }}
        run: aws s3 sync ./out s3://${{ env.TFO_BUCKET_NAME }}/${{ env.ARTIFACT_BUCKET_PREFIX }}/${{ inputs.tag }}/

      - name: push latest file manifest to s3
        working-directory: ${{ inputs.dir }}
        run: |
          echo ${{ inputs.tag }} > /tmp/latest.txt && \
          aws s3 cp /tmp/latest.txt s3://${{ env.TFO_BUCKET_NAME }}/${{ env.ARTIFACT_BUCKET_PREFIX }}/latest.txt

      - name: Check install script existence
        uses: andstor/file-existence-action@v2
        id: check_install_script
        with:
          files: "${{inputs.dir}}/install.sh"

      - name: push install.sh file to s3 if exists
        if: steps.check_install_script.outputs.files_exists == 'true'
        working-directory: ${{ inputs.dir }}
        run: |
          aws s3 cp install.sh s3://${{ env.TFO_BUCKET_NAME }}/${{ env.ARTIFACT_BUCKET_PREFIX }}/install.sh

      - name: Build and push oci-artifact
        working-directory: ${{ inputs.dir }}
        run: |
          earthly \
            ${{ env.EARTHLY_EXTRA_ARGS }} \
            --ci \
            --push \
            --remote-cache=ghcr.io/${{ github.repository }}-pkg:cache \
            +oci-artifacts \
            --repo=${{ env.ARTIFACT_ECR_REPOSITORY_URL }} \
            --region=${{ env.ARTIFACT_REGION }} \
            --image_tag=${{ inputs.tag }}
