---
name: build-base-images
on:
  workflow_call:
    inputs:
      service:
        type: string
        required: true
    outputs: {}

defaults:
  run:
    shell: bash

jobs:
  build-base:
    name: build-base
    runs-on: mono
    timeout-minutes: 15
    env:
      NO_CACHE: ${{ contains(github.event.pull_request.labels.*.name, 'no-cache') }}
      NO_REMOTE_BUILDKIT: ${{ contains(github.event.pull_request.labels.*.name, 'no-remote-buildkit') }}
      TFE_TOKEN: ${{ secrets.TFE_TOKEN }}
    steps:
      - uses: FranzDiebold/github-env-vars-action@v2
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup nuonctl
        uses: ./actions/setup-nuonctl

      - name: Use nuon buildkit in infra-shared-ci
        if: ${{ env.NO_REMOTE_BUILDKIT != 'true' }}
        run: |
         CI=true nuonctl builds driver --name ctl-api && nuonctl builds driver-health --name ctl-api || docker buildx ls

      - name: ðŸ“¦ Build base images
        run: |
         CI=true nuonctl builds base \
           --name=${{inputs.service}}
