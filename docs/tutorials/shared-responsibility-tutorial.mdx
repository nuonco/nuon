---
title: "Create a Shared Responsibility App"
description: "Learn how to support an app deployed in a customer's VPC."
icon: "aws"
---

import { YoutubeEmbed } from '/snippets/youtube-embed.mdx'

This guide walks you through supporting a shared responsibility model for a BYOC app. You will configure an app that can be installed into a customer's existing VPC. You will be able to monitor and update the install, even though the customer owns and manages the VPC it's running in.

<Note>
The component code used in this guide can be found in our [Guides repo](https://github.com/nuonco/guides).
</Note>

<YoutubeEmbed src="https://www.youtube.com/embed/9L2LuhGRdR4?si=9DWkuorUqo0xy3hh"/>

## Prerequisites

- [Create a Nuon account](/get-started/quickstart). You will need a working Nuon org.
- [Set up an AWS account](https://docs.aws.amazon.com/SetUp/latest/UserGuide/setup-overview.html). This is the account you will create the install in.
- A VPC, with the [public and private subnets tagged](/guides/sandboxes#aws-ecs-byovpc) so our sandbox can find them.

## What You Will Create

This tutorial will walk you through creating the following:

- An [App](/guides/apps)
- A [Docker Build component](/guides/docker-build-components)
- A [Terraform component](/guides/terraform-components)
- An [Install](/guides/create-installs), using our [AWS ECS BYOVPC sandbox](/guides/sandboxes#aws-ecs-byovpc)

## Configure App

To configure the app, you will create a TOML config file using our CLI. In each section below we will provide you with configuration snippets for the app itself as well as it's components.

If you would prefer to use Terraform, we also support configuring apps with our [Terraform provider](https://registry.terraform.io/providers/nuonco/nuon/latest).
Copy the Terraform files below, and then use the Terraform snippets instead of the TOML ones.

<CodeGroup>
```sh versions.tf
terraform {
  required_version = ">= 1.3.7"

  required_providers {
    nuon = {
      source  = "nuonco/nuon"
      version = ">= 0.9.1"
    }

    utils = {
      source  = "cloudposse/utils"
      version = ">= 0.17.23"
    }
  }
}
```

```hcl providers.tf
provider "nuon" {}
```
</CodeGroup>

### Create App

Define the app itself and give it a name. This will create the app in Nuon and generate a config file named `nuon.my_byovpc_app.toml`. This file will be populated with sample config, which we will update in this guide.

<CodeGroup>
```sh CLI
nuon apps create --name=my_byovpc_app
```

```hcl app.tf
resource "nuon_app" "my_byovpc_app" {
  name = "my_byovpc_app"
}
```
</CodeGroup>

### App Input

<CodeGroup>
```toml TOML
[inputs]
[[inputs.input]]
name = "vpc_id"
description = "The VPC to install the app in"
sensitive = false
display_name = "VPC ID"
required = true
```

```hcl inputs.tf
resource "nuon_app_input" "main" {
  app_id = nuon_app.my_byovpc_app.id

  input {
    name = "vpc_id"
    description = "The VPC to install the app in"
    sensitive = false
    display_name = "VPC ID"
    required = true
  }
}
```
</CodeGroup>

### Installer

Update the installer config. Installers provide an out-of-the-box installation flow your customers can use to install your app. You will use it later in this guide to create an install yourself.

<CodeGroup>
```toml TOML
[installer]
name              = "My BYOVPC App"
description       = "A demo app that runs in a customer's VPC."
slug              = "my-byovpc-app"
documentation_url = "https://docs.nuon.co/"
community_url     = "https://join.slack.com/t/nuoncommunity/shared_invite/zt-1q323vw9z-C8ztRP~HfWjZx6AXi50VRA"
logo_url          = "https://assets-global.website-files.com/62a2c1332b518a9eedc6de2f/651df2030c43865b9b16046b_Group%2048.png"
github_url        = "https://github.com/nuonco"
homepage_url      = "https://www.nuon.co/"
demo_url          = "https://www.nuon.co/"
```

```hcl installer.tf
resource "nuon_app_installer" "my_byovpc_app" {
  app_id            = nuon_app.my_byovpc_app.id
  name              = "My ECS App"
  description       = "A demo app that runs on ECS."
  slug              = nuon_app.my_byovpc_app.name
  documentation_url = "https://docs.nuon.co/"
  community_url     = "https://join.slack.com/t/nuoncommunity/shared_invite/zt-1q323vw9z-C8ztRP~HfWjZx6AXi50VRA"
  logo_url          = "https://assets-global.website-files.com/62a2c1332b518a9eedc6de2f/651df2030c43865b9b16046b_Group%2048.png"
  github_url        = "https://github.com/nuonco"
  homepage_url      = "https://www.nuon.co/"
  demo_url          = "https://www.nuon.co/"
}
```
</CodeGroup>

### Sandbox

Update the sandbox config. The aws-ecs-byovpc sandbox will provide everything you need to run ECS services on top of a pre-existing VPC.

<CodeGroup>
```toml TOML
[sandbox]
terraform_version = "1.5.4"
[sandbox.public_repo]
directory = "aws-ecs-byovpc"
repo = "nuonco/sandboxes"
branch = "main"
[[sandbox.var]]
name = "vpc_id"
value = "{{.nuon.install.inputs.vpc_id}}"
```

```hcl sandbox.tf
resource "nuon_app_sandbox" "main" {
  app_id            = nuon_app.my_byovpc_app.id
  terraform_version = "v1.6.3"
  public_repo = {
    repo      = "nuonco/sandboxes"
    branch    = "main"
    directory = "aws-ecs-byovpc"
  }
}
```
</CodeGroup>

### Runner

Update the runner config. The `aws-ecs-byovpc` sandbox requires that we use the `aws-ecs` runner. The runner manages the sandbox, provisioning and deprovisioning AWS resources during deploys.

<Tip>
The `aws-ecs` runner is so named because it runs on ECS, but it can be used to manage any AWS resources. Since it runs on ECS Fargate, no resources beyond what is needed for the runner are provisioned by default. You can use our ECS sandbox and runner to manage Lambda or EC2 deployments without worrying about extraneous ECS costs.
</Tip>

<CodeGroup>
```toml TOML
[runner]
runner_type = "aws-ecs"
```

```hcl runner.tf
resource "nuon_app_runner" "main" {
  app_id      = nuon_app.my_byovpc_app.id
  runner_type = "aws-ecs"
}
```
</CodeGroup>

### Sync App Config to Nuon

You now have a complete Nuon app config. This is a good place to stop and sync it to Nuon.

<CodeGroup>
```sh CLI
nuon apps sync
```

```sh Terraform
terraform apply
```
</CodeGroup>

Once the config is synced, select the newly created app using the CLI. This will scope CLI commands to the new app.

```sh
nuon apps select
```

## Connect Components

This app consists of two components: one to build the Docker image, and another to provision the ECS service.

### Docker Image

This is a [Docker Build component](/guides/docker-build-components) that will build the API and create a Docker image containing it. When released, it will sync the image to each install's ECR so ECS can pull it when creating tasks.

<CodeGroup>
```toml TOML
[[components]]
name   = "docker_image"
type = "docker_build"
dockerfile = "Dockerfile"
[components.public_repo]
repo      = "nuonco/guides"
directory = "aws-ecs-tutorial/components/docker-image"
branch    = "main"
```

```hcl docker_image.tf
resource "nuon_docker_build_component" "docker_image" {
  app_id = nuon_app.my_byovpc_app.id
  name   = "docker_image"

  public_repo = {
    repo      = "nuonco/guides"
    directory = "aws-ecs-tutorial/components/docker-image"
    branch    = "main"
  }
}
```
</CodeGroup>

### ECS Service

This component will create an ECS service using the docker image, and expose it to the internet with an ALB. It requires some info about the install it will run in, so we use Nuon variables to interpolate the required info on a per-install basis. See our [Using Variables](/guides/using-variables) guide for more info about how this works.

<CodeGroup>
```toml TOML
[[components]]
name   = "ecs_service"
type = "terraform_module"
terraform_version = "1.5.3"
[components.public_repo]
repo      = "nuonco/guides"
directory = "aws-ecs-tutorial/components/ecs-service"
branch    = "main"
[[components.var]]
name  = "service_name"
value = "introspect"
[[components.var]]
name  = "cluster_arn"
value = "{{.nuon.install.sandbox.outputs.ecs_cluster.arn}}"
[[components.var]]
name  = "image_url"
value = "{{.nuon.components.docker_image.image.repository.uri}}"
[[components.var]]
name  = "image_tag"
value = "{{.nuon.components.docker_image.image.tag}}"
[[components.var]]
name  = "app_id"
value = "{{.nuon.app.id}}"
[[components.var]]
name  = "org_id"
value = "{{.nuon.org.id}}"
[[components.var]]
name  = "install_id"
value = "{{.nuon.install.id}}"
[[components.var]]
name  = "vpc_id"
value = "{{.nuon.install.sandbox.outputs.vpc.id}}"
[[components.var]]
name  = "domain_name"
value = "introspect.{{.nuon.install.sandbox.outputs.public_domain.name}}"
[[components.var]]
name  = "zone_id"
value = "{{.nuon.install.sandbox.outputs.public_domain.zone_id}}"
```

```hcl ecs_service.tf
resource "nuon_terraform_module_component" "ecs_service" {
  app_id = nuon_app.my_byovpc_app.id
  name   = "ecs_service"

  public_repo = {
    repo      = "nuonco/guides"
    directory = "aws-ecs-tutorial/components/ecs-service"
    branch    = "main"
  }

  # Service config

  var {
    name  = "service_name"
    value = "introspect"
  }

  var {
    name  = "cluster_arn"
    value = "{{.nuon.install.sandbox.outputs.ecs_cluster.arn}}"
  }

  var {
    name  = "image_url"
    value = "{{.nuon.components.docker_image.image.repository.uri}}"
  }

  var {
    name  = "image_tag"
    value = "{{.nuon.components.docker_image.image.tag}}"
  }

  var {
    name  = "app_id"
    value = "{{.nuon.app.id}}"
  }

  var {
    name  = "org_id"
    value = "{{.nuon.org.id}}"
  }

  var {
    name  = "install_id"
    value = "{{.nuon.install.id}}"
  }


  # Load balancer config

  var {
    name  = "vpc_id"
    value = "{{.nuon.install.sandbox.outputs.vpc.id}}"
  }

  var {
    name  = "domain_name"
    value = "introspect.{{.nuon.install.sandbox.outputs.public_domain.name}}"
  }

  var {
    name  = "zone_id"
    value = "{{.nuon.install.sandbox.outputs.public_domain.zone_id}}"
  }

  dependencies = [
    nuon_docker_build_component.docker_image.id
  ]
}
```
</CodeGroup>

### Sync Component Configs to Nuon

Now that you have the components, sync the update config to Nuon.

<CodeGroup>
```sh CLI
nuon apps sync
```

```sh Terraform
terraform apply
```
</CodeGroup>

Just like the app, you can use the CLI to verify they were synced successfully.

```sh
nuon components list
```

Initial builds for each component will also have been created. Verify with the CLI that they were successful.

<CodeGroup>
```sh verify docker_image build
nuon builds list -c docker_image
```

```sh verify ecs_service build
nuon builds list -c ecs_service
```
</CodeGroup>

## Create an Install

Creating an install requires two steps: granting access to the AWS account via an IAM role, and then provisioning the install in that account.
There are a few ways to do this, but the easiest is to use the installer you configured earlier.

In your web browser, navigate to [https://app.nuon.co/installer/your-installer-slug](https://app.nuon.co/installer/<your-installer-slug>), and follow the steps in the UI.
You should see a field where you can put the ID of the VPC you want to install the app in.

For other approaches, see our guides [Install Access Permissions](/guides/install-access-permissions)  and [Create Installs](/guides/create-installs).

### Monitor Install Creation

Monitor the install's creation using the Dashboard. Scroll down, and below the settings, you should see a card for your install.

![Installs on Dashboard](/images/installs-on-dashboard.png)

Click on the card, and in the sidebar you can verify that the components are deployed in the Deploy History.

![Install Details on Dashboard](/images/install-details-on-dashboard.png)

### Inspect the Install

When the install has provisioned, and the deploys have completed, copy the install ID from the UI and curl the API to verify it's running.


```sh curl api
curl https://introspect.{install_id}.nuon.run/introspect/env
```

## Wrapping Up and Next Steps

Congratulations, you just deployed a shared responsibility app to a VPC in AWS! A few suggestions for where to go next:

- Check out our [Release Management](/guides/create-releases) guide to learn how to update installs.
- Dig into our [App Configuration](/guides/apps) guide to learn how to configure more complex apps.
- Share your installer with a friend and have them install your app in their AWS account.
